<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>guide - Japanese helper</title>

<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial; background: #f6f7fb; }
body { margin: 0; }
.header { background: white; border-bottom: 1px solid #e5e7eb; padding: 12px 16px; }
.title { font-weight: 700; font-size: 18px; }

.main { max-width: 900px; margin: 0 auto; padding: 16px; }
.grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }

.card { background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 14px; }
.row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }

.group { min-width: 170px; }
.label { font-size: 12px; color: #6b7280; margin-bottom: 6px; }

.seg { display: inline-flex; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
.seg button { border: 0; background: white; padding: 8px 10px; cursor: pointer; }
.seg .active { background: #111827; color: white; }

.prompt { font-size: 56px; font-weight: 800; text-align: center; margin: 8px 0 4px; }
.subprompt { text-align: center; color: #6b7280; margin-bottom: 6px; font-size: 14px; }

.choices { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.choice { padding: 12px; border: 1px solid #e5e7eb; border-radius: 14px; background: white; font-size: 18px; cursor: pointer; }
.correct { background: #ecfdf5; border-color: #16a34a; }
.wrong { background: #fef2f2; border-color: #dc2626; }

.actions { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
.primary, .ghost, .playBtn, .danger {
  padding: 10px 12px; border-radius: 12px; cursor: pointer; font-weight: 700;
  border: 1px solid #e5e7eb; background: white;
}
.primary { background: #111827; color: white; border-color: #111827; }
.playBtn { border-style: dashed; }
.danger { border-color: #fecaca; background: #fff1f2; }

.hint { margin-top: 10px; font-weight: 700; }
.small { font-size: 12px; color: #6b7280; font-weight: 500; line-height: 1.4; }
.badge { display: inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 12px; color: #374151; background: #fff; }

textarea {
  width: 100%;
  min-height: 110px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  padding: 10px 12px;
  font-size: 16px;
  outline: none;
}
textarea:focus { border-color: #111827; }

.kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
.live { color: #6b7280; }
.final { color: #111827; font-weight: 800; }
.note { margin-top: 10px; padding: 10px 12px; border: 1px dashed #d1d5db; border-radius: 12px; background: #fff; }
</style>
</head>

<body>
<div class="header">
  <div class="title">guide â€“ Japanese helper <span class="badge">è½åŠ› + èªéŸ³è¾¨è­˜</span></div>
</div>

<div class="main">
  <div class="grid">

    <!-- å·¦å´ï¼š50éŸ³æ¸¬é©— -->
    <div class="card">
      <div class="row">
        <div class="group">
          <div class="label">æ–‡å­—ç³»çµ±</div>
          <div class="seg">
            <button id="hiraBtn" class="active">å¹³å‡å</button>
            <button id="kataBtn">ç‰‡å‡å</button>
          </div>
        </div>

        <div class="group">
          <div class="label">æ¨¡å¼</div>
          <div class="seg">
            <button id="k2rBtn" class="active">å‡åâ†’ç™¼éŸ³</button>
            <button id="r2kBtn">ç™¼éŸ³â†’å‡å</button>
            <button id="l2kBtn">è½åŠ›â†’å‡å</button>
          </div>
          <div class="small">è½åŠ›æ¨¡å¼ç”¨ç€è¦½å™¨ TTS æ’­æ”¾ã€Œå‡åã€</div>
        </div>

        <div class="group">
          <div class="label">åˆ†æ•¸</div>
          <div id="scoreBox">0 / 0</div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div id="prompt" class="prompt">ã‚</div>
        <div id="subprompt" class="subprompt"></div>
        <div id="choices" class="choices"></div>

        <div class="actions">
          <button id="playBtn" class="playBtn">ğŸ”Š æ’­æ”¾</button>
          <button id="nextBtn" class="primary">ä¸‹ä¸€é¡Œ</button>
          <button id="resetBtn" class="ghost">é‡ç½®åˆ†æ•¸</button>
        </div>

        <div id="hint" class="hint"></div>
      </div>
    </div>

    <!-- å³å´ï¼šèªéŸ³è¾¨è­˜ -->
    <div class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div>
          <div style="font-weight:800; font-size:18px;">ğŸ¤ èªéŸ³è®€å…¥ â†’ æ—¥æ–‡æ–‡å­—</div>
          <div class="small">
            ä½¿ç”¨ <span class="kbd">SpeechRecognition</span>ï¼ˆChrome/Edge æœ€ç©©ï¼‰ã€‚
            iOS Safari å¯èƒ½ä¸æ”¯æ´ã€‚
          </div>
        </div>
        <div class="badge" id="srStatus">ç‹€æ…‹ï¼šæœªå•Ÿå‹•</div>
      </div>

      <div class="actions">
        <button id="srStartBtn" class="primary">é–‹å§‹éŒ„éŸ³</button>
        <button id="srStopBtn" class="ghost" disabled>åœæ­¢</button>
        <button id="srClearBtn" class="danger">æ¸…é™¤</button>
        <button id="srSpeakBtn" class="playBtn">ğŸ”Š æŠŠçµæœå”¸å‡ºä¾†</button>
      </div>

      <div class="note">
        <div class="small">å³æ™‚è¾¨è­˜ï¼ˆinterimï¼‰ï¼š<span class="live" id="srLive">ï¼ˆç©ºï¼‰</span></div>
        <div class="small">æœ€çµ‚çµæœï¼ˆfinalï¼‰ï¼š<span class="final" id="srFinal">ï¼ˆç©ºï¼‰</span></div>
      </div>

      <div style="margin-top:10px;">
        <div class="label">ä½ ä¹Ÿå¯ä»¥æ‰‹å‹•è²¼ä¸Š/ä¿®æ­£ï¼š</div>
        <textarea id="srText" placeholder="è¾¨è­˜çµæœæœƒåŒæ­¥åˆ°é€™è£¡ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±ä¿®æ”¹â€¦"></textarea>
      </div>

      <div class="note small">
        å»ºè­°ï¼šä½ å¯ä»¥å”¸çŸ­å¥ï¼Œä¾‹å¦‚ã€Œã‚ãŸã—ã¯ ãã‚“ã‚‚ã‚“ ã« ã™ã‚“ã§ã„ã¾ã™ã€ï¼Œ
        çœ‹çœ‹è¾¨è­˜æ˜¯å¦è½‰æˆã€Œç§ã¯é‡‘é–€ã«ä½ã‚“ã§ã„ã¾ã™ã€ä¹‹é¡çš„æ–‡å­—ã€‚
      </div>
    </div>

  </div>
</div>

<script>
// =================== 50éŸ³æ¸¬é©—ï¼ˆåŒå‰ç‰ˆï¼‰ ===================
const KANA = [
["ã‚","ã‚¢","a"],["ã„","ã‚¤","i"],["ã†","ã‚¦","u"],["ãˆ","ã‚¨","e"],["ãŠ","ã‚ª","o"],
["ã‹","ã‚«","ka"],["ã","ã‚­","ki"],["ã","ã‚¯","ku"],["ã‘","ã‚±","ke"],["ã“","ã‚³","ko"],
["ã•","ã‚µ","sa"],["ã—","ã‚·","shi"],["ã™","ã‚¹","su"],["ã›","ã‚»","se"],["ã","ã‚½","so"],
["ãŸ","ã‚¿","ta"],["ã¡","ãƒ","chi"],["ã¤","ãƒ„","tsu"],["ã¦","ãƒ†","te"],["ã¨","ãƒˆ","to"],
["ãª","ãƒŠ","na"],["ã«","ãƒ‹","ni"],["ã¬","ãƒŒ","nu"],["ã­","ãƒ","ne"],["ã®","ãƒ","no"],
["ã¯","ãƒ","ha"],["ã²","ãƒ’","hi"],["ãµ","ãƒ•","fu"],["ã¸","ãƒ˜","he"],["ã»","ãƒ›","ho"],
["ã¾","ãƒ","ma"],["ã¿","ãƒŸ","mi"],["ã‚€","ãƒ ","mu"],["ã‚","ãƒ¡","me"],["ã‚‚","ãƒ¢","mo"],
["ã‚„","ãƒ¤","ya"],["ã‚†","ãƒ¦","yu"],["ã‚ˆ","ãƒ¨","yo"],
["ã‚‰","ãƒ©","ra"],["ã‚Š","ãƒª","ri"],["ã‚‹","ãƒ«","ru"],["ã‚Œ","ãƒ¬","re"],["ã‚","ãƒ­","ro"],
["ã‚","ãƒ¯","wa"],["ã‚’","ãƒ²","wo"],
["ã‚“","ãƒ³","n"]
];

let script = "hira"; // hira | kata
let mode = "k2r";    // k2r | r2k | l2k
let current;
let correct;
let score = { c:0, t:0 };
let revealed = false;

function rand(n){ return Math.floor(Math.random()*n); }
function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
function kanaLabel(item){ return script==="hira" ? item[0] : item[1]; }

// ===== TTSï¼šå”¸å‡åï¼ˆæ¯”å”¸ romaji æº–ï¼‰=====
function speakKana(kanaText){
  if(!("speechSynthesis" in window)) {
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ SpeechSynthesisã€‚å»ºè­°ç”¨ Chrome / Edgeã€‚");
    return;
  }
  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(kanaText);
  u.lang = "ja-JP";
  u.rate = 0.9;
  u.pitch = 1.0;

  const voices = window.speechSynthesis.getVoices?.() || [];
  const jp = voices.find(v => (v.lang || "").toLowerCase().startsWith("ja"));
  if(jp) u.voice = jp;

  window.speechSynthesis.speak(u);
}

if("speechSynthesis" in window){
  window.speechSynthesis.onvoiceschanged = () => {};
}

function updateScore(){
  document.getElementById("scoreBox").textContent = `${score.c} / ${score.t}`;
}

function renderChoices(arr){
  const box=document.getElementById("choices");
  box.innerHTML="";

  arr.forEach(v=>{
    const b=document.createElement("button");
    b.className="choice";
    b.textContent=v;

    b.onclick=()=>{
      if(revealed) return;
      revealed=true;

      score.t++;
      if(v===correct){
        score.c++;
        b.classList.add("correct");
      }else{
        b.classList.add("wrong");
      }

      updateScore();
      document.getElementById("hint").textContent =
        `æ­£è§£ï¼š${correct}ï¼ˆ${current[0]} / ${current[1]} = ${current[2]}ï¼‰`;
    };

    box.appendChild(b);
  });
}

function newQuestion(){
  revealed = false;
  document.getElementById("hint").textContent = "";

  current = KANA[rand(KANA.length)];
  const [h,k,r] = current;

  const promptEl = document.getElementById("prompt");
  const subEl = document.getElementById("subprompt");

  if(mode==="k2r"){
    promptEl.textContent = kanaLabel(current);
    subEl.textContent = "è«‹é¸æ“‡æ­£ç¢ºçš„ romaji ç™¼éŸ³";
    correct = r;

    let opts=[r];
    while(opts.length<4){
      const rr = KANA[rand(KANA.length)][2];
      if(!opts.includes(rr)) opts.push(rr);
    }
    renderChoices(shuffle(opts));

  } else if(mode==="r2k"){
    promptEl.textContent = r;
    subEl.textContent = "è«‹é¸æ“‡æ­£ç¢ºçš„å‡å";
    correct = kanaLabel(current);

    let opts=[correct];
    while(opts.length<4){
      const kk2 = script==="hira"
        ? KANA[rand(KANA.length)][0]
        : KANA[rand(KANA.length)][1];
      if(!opts.includes(kk2)) opts.push(kk2);
    }
    renderChoices(shuffle(opts));

  } else { // l2k
    promptEl.textContent = "ğŸ”Š";
    subEl.textContent = "æŒ‰æ’­æ”¾è½ç™¼éŸ³ï¼Œé¸å‡ºæ­£ç¢ºå‡åï¼ˆå¯é‡æ’­ï¼‰";
    correct = kanaLabel(current);

    let opts=[correct];
    while(opts.length<4){
      const kk2 = script==="hira"
        ? KANA[rand(KANA.length)][0]
        : KANA[rand(KANA.length)][1];
      if(!opts.includes(kk2)) opts.push(kk2);
    }
    renderChoices(shuffle(opts));
    setTimeout(()=> speakKana(kanaLabel(current)), 120);
  }
}

// UI events
const hiraBtn = document.getElementById("hiraBtn");
const kataBtn = document.getElementById("kataBtn");
const k2rBtn  = document.getElementById("k2rBtn");
const r2kBtn  = document.getElementById("r2kBtn");
const l2kBtn  = document.getElementById("l2kBtn");

hiraBtn.onclick=()=>{
  script="hira";
  hiraBtn.classList.add("active");
  kataBtn.classList.remove("active");
  newQuestion();
};
kataBtn.onclick=()=>{
  script="kata";
  kataBtn.classList.add("active");
  hiraBtn.classList.remove("active");
  newQuestion();
};
k2rBtn.onclick=()=>{
  mode="k2r";
  k2rBtn.classList.add("active");
  r2kBtn.classList.remove("active");
  l2kBtn.classList.remove("active");
  newQuestion();
};
r2kBtn.onclick=()=>{
  mode="r2k";
  r2kBtn.classList.add("active");
  k2rBtn.classList.remove("active");
  l2kBtn.classList.remove("active");
  newQuestion();
};
l2kBtn.onclick=()=>{
  mode="l2k";
  l2kBtn.classList.add("active");
  k2rBtn.classList.remove("active");
  r2kBtn.classList.remove("active");
  newQuestion();
};

document.getElementById("nextBtn").onclick=()=>newQuestion();
document.getElementById("resetBtn").onclick=()=>{
  score={c:0,t:0};
  updateScore();
  newQuestion();
};
document.getElementById("playBtn").onclick=()=>{
  if(!current) return;
  speakKana(kanaLabel(current));
};

// =================== èªéŸ³è¾¨è­˜ï¼ˆSpeechRecognitionï¼‰ ===================
const srStatus = document.getElementById("srStatus");
const srStartBtn = document.getElementById("srStartBtn");
const srStopBtn  = document.getElementById("srStopBtn");
const srClearBtn = document.getElementById("srClearBtn");
const srSpeakBtn = document.getElementById("srSpeakBtn");

const srLiveEl  = document.getElementById("srLive");
const srFinalEl = document.getElementById("srFinal");
const srText    = document.getElementById("srText");

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recog = null;
let recognizing = false;

function setSRStatus(text){
  srStatus.textContent = `ç‹€æ…‹ï¼š${text}`;
}

function ensureRecognition(){
  if(!SpeechRecognition){
    setSRStatus("ä¸æ”¯æ´ï¼ˆå»ºè­° Chrome/Edgeï¼‰");
    alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ SpeechRecognitionï¼ˆèªéŸ³è¾¨è­˜ï¼‰ã€‚å»ºè­°ç”¨ Chrome / Edge æ¡Œæ©Ÿæˆ– Androidã€‚iOS Safari é€šå¸¸ä¸æ”¯æ´ã€‚");
    return null;
  }
  if(recog) return recog;

  recog = new SpeechRecognition();
  recog.lang = "ja-JP";
  recog.interimResults = true;
  recog.continuous = true; // å¯æŒçºŒè½

  recog.onstart = () => {
    recognizing = true;
    setSRStatus("éŒ„éŸ³ä¸­â€¦");
    srStartBtn.disabled = true;
    srStopBtn.disabled = false;
  };

  recog.onend = () => {
    recognizing = false;
    setSRStatus("å·²åœæ­¢");
    srStartBtn.disabled = false;
    srStopBtn.disabled = true;
  };

  recog.onerror = (e) => {
    setSRStatus("éŒ¯èª¤ï¼š" + (e.error || "unknown"));
  };

  recog.onresult = (event) => {
    let interim = "";
    let finalText = srFinalEl.textContent === "ï¼ˆç©ºï¼‰" ? "" : srFinalEl.textContent;

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      const txt = res[0].transcript;
      if(res.isFinal){
        finalText += (finalText ? " " : "") + txt.trim();
      } else {
        interim += txt;
      }
    }

    srLiveEl.textContent = interim ? interim : "ï¼ˆç©ºï¼‰";
    srFinalEl.textContent = finalText ? finalText : "ï¼ˆç©ºï¼‰";

    // åŒæ­¥åˆ° textareaï¼ˆæ–¹ä¾¿ä½ æ‰‹å‹•ä¿®æ­£ï¼‰
    srText.value = finalText;
  };

  return recog;
}

srStartBtn.onclick = () => {
  const r = ensureRecognition();
  if(!r) return;
  try { r.start(); } catch(_) {}
};

srStopBtn.onclick = () => {
  if(recog && recognizing){
    recog.stop();
  }
};

srClearBtn.onclick = () => {
  srLiveEl.textContent = "ï¼ˆç©ºï¼‰";
  srFinalEl.textContent = "ï¼ˆç©ºï¼‰";
  srText.value = "";
};

srSpeakBtn.onclick = () => {
  const t = (srText.value || "").trim();
  if(!t){
    alert("ç›®å‰æ²’æœ‰è¾¨è­˜çµæœå¯æ’­æ”¾ã€‚");
    return;
  }
  // æŠŠè¾¨è­˜å‡ºçš„æ—¥æ–‡å†å”¸ä¸€æ¬¡ï¼Œç•¶ä½œè‡ªæˆ‘æ ¡æ­£
  speakKana(t);
};

// è®“ä½ æ‰‹å‹•ä¿®æ”¹ textarea æ™‚ï¼ŒåŒæ­¥åˆ° final é¡¯ç¤º
srText.addEventListener("input", () => {
  const t = srText.value.trim();
  srFinalEl.textContent = t ? t : "ï¼ˆç©ºï¼‰";
});

// =================== å•Ÿå‹• ===================
updateScore();
newQuestion();
setSRStatus(SpeechRecognition ? "æœªå•Ÿå‹•" : "ä¸æ”¯æ´");
</script>
</body>
</html>
